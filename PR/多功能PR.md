# AI Chat 多功能增强 PR

## 概述

本次 PR 包含大量功能增强和 Bug 修复，主要涵盖以下几个方面：

- 🛠️ 工具系统增强
- 📝 Markdown 渲染优化
- 💬 聊天体验改进
- 🎨 UI/UX 优化
- 📁 文件处理扩展
- 🧠 记忆管理改进

---

## 🛠️ 工具系统增强

### 新增工具
- `getTodayJournal` - 获取今日日记
- `getBlock` - 按 ID 获取块内容
- `getBlockMeta` - 批量获取块元数据
- `getBlockLinks` - 获取出链/入链列表

### 工具改进
- 搜索工具添加分页支持（offset 参数）
- 搜索工具添加上限警告
- 修复工具调用重复执行问题
- 修复 createBlock 返回 undefined 问题
- 修复标签搜索和 fallback 重试问题
- 改进工具提示词精细度，提升调用准确性
- 为每个工具添加中文显示名称

---

## 📝 Markdown 渲染优化

### 新增渲染支持
- 表格渲染（支持多视图：表格/卡片/列表）
- 有序/无序列表渲染
- Checkbox 列表和任务卡片
- 时间线渲染（支持颜色分类）
- 对比视图渲染
- 进度条渲染
- 图片块识别和渲染

### 渲染改进
- Block 引用添加悬浮预览
- Block 引用小圆点优化
- 修复 block link 嵌套渲染问题
- 修复图片和链接语法被错误清理的问题
- 支持 `blockid 123` 格式（空格分隔）
- 表格添加复制按钮
- 表格暗色模式样式修复
- 嵌套列表支持缩进

---

## 💬 聊天体验改进

### 新功能
- 闪卡生成功能（/card 命令）
- 本地链接图谱功能（/localgraph 命令）
- 斜杠命令扩展（/timeline, /compare, /brief, /detail, /table, /summary）
- 建议回复功能
- 消息时间显示
- 对话目录导航
- 删除单条消息功能
- 清除上下文功能
- 历史对话收藏功能
- 显示 AI 推理过程

### 改进
- 历史对话标题仅首次自动生成
- 历史对话仅在发送新消息时更新排序位置
- 工具结果合并到 assistant 消息折叠区
- 工具调用完成后自动折叠
- 修复消息时间显示，正确区分今天/昨天/更早

---

## 🎨 UI/UX 优化

### 样式改进
- 统一 Agent/Ask 模式图标为 Tabler Icons 风格
- 列表样式改为公众号风格
- 优化暗色模式下列表和其他组件显示
- 修复历史记录和上下文选择器暗色模式适配
- 改进视频模式切换按钮样式
- 修复工具调用折叠展开时溢出和重叠问题
- 优化历史对话条目布局，更紧凑

### 交互改进
- 小圆点点击区域增加
- 收藏筛选按钮视觉反馈改进

---

## 📁 文件处理扩展

### 新增支持
- 图片导入和多模态消息
- PDF/Word/Excel 文档解析
- 视频处理模式切换
- 视频缩略图预览
- 上下文附件支持

### 修复
- 修复 Agent 模式下文件无法识别的问题

---

## 🧠 记忆管理改进

- 修复全局记忆编辑时中文输入法光标跳转问题
- 允许编辑印象分组中信息项的标签
- 优化印象管理界面：用户标签并列显示、AI 印象刷新、值拖拽排序
- 记忆管理多选功能

---

## 🔧 重构

- 移除 Supervised 模式
- 简化模式切换，恢复原始 Agent 逻辑
- 表格样式改用 CSS class
- 移除推理过程翻译功能并优化显示

---

## 🐛 Bug 修复

- 修复别名块显示为 Block #id 的问题
- 修复 getBlock 显示 [object Object] 的问题
- 修复 getBlock 工具 content.split 类型检查
- 防止 createBlock 重复调用
- 修复 TOC heading navigation not scrolling to target
- 修复 Gemini API 兼容性问题
- 强化块引用格式提示，防止 AI 使用错误格式

---

## 测试建议

1. **工具调用测试**
   - 测试 `列出所有 #Task 标签且 Status = Canceled 的笔记`
   - 测试 `今天日记写了什么`
   - 测试 `搜索包含"学习"的笔记`

2. **Markdown 渲染测试**
   - 测试表格多视图切换
   - 测试时间线渲染（/timeline 命令）
   - 测试对比视图（/compare 命令）

3. **闪卡功能测试**
   - 测试 `/card 减肥` 生成闪卡
   - 测试闪卡保存到日记

4. **图谱功能测试**
   - 测试 `/localgraph 页面名称`

5. **文件导入测试**
   - 测试图片、PDF、Word、Excel 导入
